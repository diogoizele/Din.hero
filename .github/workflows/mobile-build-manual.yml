name: Mobile Manual Build

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to build"
        required: true
        type: choice
        options:
          - android
          - ios
          - both
      build_configuration:
        description: "Build configuration"
        required: true
        type: choice
        options:
          - debugDevelopment
          - debugProduction
          - releaseDevelopment
          - releaseProduction

env:
  BUILD_CONFIGURATION: ${{ github.event.inputs.build_configuration }}
  PLATFORM: ${{ github.event.inputs.platform }}

jobs:
  android-build:
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ hashFiles('bun.lockb') }}

      - name: Install dependencies
        run: bun install

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}

      - name: Prepare Android keystore (release only)
        if: github.event.inputs.build_configuration == 'releaseDevelopment' || github.event.inputs.build_configuration == 'releaseProduction'
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/release.keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Prepare Firebase Android json (development)
        if: github.event.inputs.build_configuration == 'debugDevelopment' || github.event.inputs.build_configuration == 'releaseDevelopment'
        run: |
          mkdir -p android/app/src/development
          echo "$ANDROID_GOOGLE_SERVICES_JSON_DEVELOPMENT_BASE64" | base64 --decode > android/app/src/development/google-services.json
        env:
          ANDROID_GOOGLE_SERVICES_JSON_DEVELOPMENT_BASE64: ${{ secrets.ANDROID_GOOGLE_SERVICES_JSON_DEVELOPMENT_BASE64 }}

      - name: Prepare Firebase Android json (production)
        if: github.event.inputs.build_configuration == 'debugProduction' || github.event.inputs.build_configuration == 'releaseProduction'
        run: |
          mkdir -p android/app/src/production
          echo "$ANDROID_GOOGLE_SERVICES_JSON_PRODUCTION_BASE64" | base64 --decode > android/app/src/production/google-services.json
        env:
          ANDROID_GOOGLE_SERVICES_JSON_PRODUCTION_BASE64: ${{ secrets.ANDROID_GOOGLE_SERVICES_JSON_PRODUCTION_BASE64 }}

      - name: Build Android
        id: android_build
        run: |
          case "$BUILD_CONFIGURATION" in
            debugDevelopment)
              cd android && ./gradlew assembleDevelopmentDebug && cd ..
              echo "APK_DIR=android/app/build/outputs/apk/development/debug" >> $GITHUB_ENV
              ;;
            debugProduction)
              cd android && ./gradlew assembleProductionDebug && cd ..
              echo "APK_DIR=android/app/build/outputs/apk/production/debug" >> $GITHUB_ENV
              ;;
            releaseDevelopment)
              cd android && ./gradlew assembleDevelopmentRelease && cd ..
              echo "APK_DIR=android/app/build/outputs/apk/development/release" >> $GITHUB_ENV
              ;;
            releaseProduction)
              cd android && ./gradlew assembleProductionRelease && cd ..
              echo "APK_DIR=android/app/build/outputs/apk/production/release" >> $GITHUB_ENV
              ;;
            *)
              echo "Unknown BUILD_CONFIGURATION: $BUILD_CONFIGURATION"
              exit 1
              ;;
          esac
        env:
          BUILD_CONFIGURATION: ${{ github.event.inputs.build_configuration }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

